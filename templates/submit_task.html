{% extends 'base.html' %}

{% block content %}
  <h1>Enviar Tarea - {{ task.title }}</h1>

  <form id="taskSubmissionForm" method="post" enctype="multipart/form-data" action="{% url 'submit_task' task_id=task.id %}">
    {% csrf_token %}

    {{ form.non_field_errors }}
    <div>{{ form.comentarios }}</div>
    <div>{{ form.archivos_adjuntos }}</div>
    <div>{{ form.calificacion }}</div>

    <input type="hidden" name="action" value="enviar"> {# Campo oculto para la acción #}

    <label>
      {{ form.confirmar_entrega }} Confirmar Entrega
    </label>

    {% if not entrega or not entrega.anulada %}
      <button type="submit" id="enviarBtn">Enviar Tarea</button>
    {% endif %}
  </form>

  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if entrega %}
    {% if entrega.entregada and not entrega.anulada %}
      <!-- Muestra detalles de entrega si ya se ha enviado -->
      <p>Detalles de la Entrega:</p>
      <p>Fecha de entrega: {{ entrega.fecha_entrega }}</p>
      <p>Comentarios: {{ entrega.comentarios }}</p>
      {% if entrega.archivos_adjuntos %}
        <p>Archivos Adjuntos: <a href="{{ entrega.archivos_adjuntos.url }}" target="_blank">Ver Archivo Adjunto</a></p>
      {% else %}
        <p>No se adjuntaron archivos.</p>
      {% endif %}

      <!-- Permitir anular la entrega -->
      <form method="post" action="{% url 'anular_entrega' task_id=task.id %}">
        {% csrf_token %}
        <button type="submit" id="anularBtn" {% if not entrega.entregada %}disabled{% endif %}>Anular Entrega</button>
      </form>

      {% if entrega.calificacion %}
        <p>Calificación: {{ entrega.calificacion }}/100</p>
      {% endif %}
    {% endif %}
  {% endif %}

  {% with entrega_entregada=entrega.entregada|yesno:"true,false" %}
  <script>
    var entregaEntregada = "{{ entrega_entregada }}";
  
    document.addEventListener("DOMContentLoaded", function () {
      var form = document.getElementById("taskSubmissionForm");
      var enviarBtn = document.getElementById("enviarBtn");
      var anularBtn = document.getElementById("anularBtn");
      var comentariosInput = document.getElementById("comentarios");
  
      if (entregaEntregada === "true" && !anuladoPorEstudiante()) {
        // Entrega realizada y no anulada, deshabilitar la edición
        var elements = form.elements;
        for (var i = 0; i < elements.length; i++) {
          elements[i].setAttribute("readonly", "readonly");
        }
  
        enviarBtn.setAttribute("disabled", "disabled");
      } else {
        // Anular la entrega ya no es posible si la tarea no se ha enviado
        if (!anuladoPorEstudiante()) {
          anularBtn.setAttribute("disabled", "disabled");
        }
        enviarBtn.addEventListener("click", function () {
          // Después de enviar la tarea, bloquear el botón
          enviarBtn.setAttribute("disabled", "disabled");
        });
      }
  
      anularBtn.addEventListener("click", function () {
        // Lógica para anular la entrega
        // Puedes realizar aquí las operaciones necesarias para anular la entrega
        // Después de anularla, habilita la edición y el botón de enviar
        habilitarEdicion();
      });
    });
  
    function anuladoPorEstudiante() {
      // Lógica para determinar si el estudiante ha anulado la entrega
      // Puedes adaptar esta función según cómo determines el estado de anulación
      // Por ejemplo, puedes tener un campo en tu modelo de entrega que indique si fue anulado
      // o puedes verificar si hay una acción específica realizada por el estudiante en tu sistema.
      // Aquí uso una función de ejemplo que deberías reemplazar con la lógica real.
      return true; // Reemplazar con tu lógica real
    }
  
    function habilitarEdicion() {
      var elements = form.elements;
      for (var i = 0; i < elements.length; i++) {
        elements[i].removeAttribute("readonly");
      }
  
      enviarBtn.removeAttribute("disabled");
    }
  </script>
  {% endwith %}
{% endblock %}
